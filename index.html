<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Batch Image Cropper & Resizer | By Pierre Cochart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --google-blue: #4285F4;
            --google-blue-hover: #3367d6;
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
            --google-grey: #f1f3f4;
            --text-dark: #202124;
            --text-grey: #5f6368;
            --border-color: #dadce0;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', -apple-system, sans-serif; 
            background: var(--google-grey); 
            padding: 20px; 
            color: var(--text-dark);
            margin: 0;
        }

        /* --- LAYOUT GRID --- */
        .main-wrapper {
            display: flex;
            flex-direction: row; 
            gap: 30px;
            max-width: 1100px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .instructions-container {
            flex: 1;
            background: transparent;
            padding: 10px;
            min-width: 250px;
        }

        .instructions-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .tool-container { 
            flex: 2;
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15); 
            width: 100%;
        }

        h1 { margin-top: 0; color: var(--text-dark); font-size: 24px; font-weight: 400; margin-bottom: 25px; }
        h2 { font-size: 18px; margin-top: 0; color: var(--google-blue); }
        p, li { font-size: 14px; line-height: 1.5; color: var(--text-grey); }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 14px; }
        .sub-label { font-size: 12px; color: var(--text-grey); margin-bottom: 8px; margin-top: -4px; }
        
        /* Unified input styling */
        input[type="text"], input[type="number"], select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            font-size: 14px; 
            color: var(--text-dark); 
            transition: all 0.2s;
            height: 44px; /* Fixed Height for consistency */
            margin: 0;
            background: white;
        }

        /* FIX FOR TWITCHING: 
           Instead of changing border-width (which moves layout), 
           we use box-shadow to fake the thickness.
        */
        input:focus, select:focus { 
            border-color: var(--google-blue);
            box-shadow: 0 0 0 1px var(--google-blue); 
            outline: none; 
            padding: 10px 12px; /* Padding stays exactly the same */
        }
        
        input[type="file"] { 
            width: 100%; padding: 20px; height: auto;
            background: #f8f9fa; border: 2px dashed var(--border-color); 
            border-radius: 6px; text-align: center; cursor: pointer; color: var(--text-grey);
        }
        input[type="file"]:hover { background: #e8f0fe; border-color: var(--google-blue); }

        /* --- BUTTONS --- */
        button { font-family: 'Roboto', sans-serif; cursor: pointer; border: none; }
        
        .btn-add { 
            background-color: var(--google-blue); 
            color: white; 
            border: none; 
            padding: 0 20px; 
            border-radius: 4px; 
            font-weight: 500; 
            height: 44px; /* Matches Input Height Exactly */
            transition: background 0.2s;
            white-space: nowrap;
        }
        .btn-add:hover { background-color: var(--google-blue-hover); }

        .btn-process { 
            width: 100%; padding: 14px; 
            background-color: var(--google-blue); color: white; 
            border-radius: 4px; font-size: 16px; font-weight: 500; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); margin-top: 10px; letter-spacing: 0.5px; 
        }
        .btn-process:hover { background-color: var(--google-blue-hover); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .btn-process:disabled { background-color: var(--border-color); color: #fff; cursor: not-allowed; box-shadow: none; }

        /* --- SIZE MANAGER --- */
        .size-input-wrapper { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 12px; 
            align-items: center; /* Changed from flex-end to center for stability */
        }
        .size-input-group { flex: 1; }
        .unit-select { flex: 0 0 70px; } 
        
        .size-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-top: 16px; 
            width: 100%;
        }
        
        .size-tag { 
            padding: 6px 14px; border-radius: 18px; font-size: 13px; 
            display: inline-flex; align-items: center; gap: 8px; color: white; 
            font-weight: 500; box-shadow: 0 1px 2px rgba(0,0,0,0.15); 
            white-space: nowrap; 
        }
        .size-remove { 
            cursor: pointer; font-weight: bold; font-size: 16px; 
            line-height: 1; margin-left: 2px; opacity: 0.8; 
        }
        .size-remove:hover { opacity: 1; }

        /* --- PREVIEW CANVAS --- */
        #previewContainer { text-align: center; margin-top: 24px; display: none; background: #fff; border: 1px solid var(--border-color); padding: 16px; border-radius: 8px;}
        canvas { max-width: 100%; height: auto; border-radius: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background: #eee; }
        .preview-label { font-size: 16px; color: var(--text-dark); margin-bottom: 16px; font-weight: 500; }
        .preview-legend { font-size: 13px; color: var(--text-grey); margin-bottom: 16px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;}
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        /* --- LOGS --- */
        #status { margin-top: 20px; padding: 12px; background: var(--google-grey); border-radius: 4px; font-size: 13px; color: var(--text-dark); display: none; white-space: pre-line; max-height: 200px; overflow-y: auto; font-family: monospace; border-left: 4px solid var(--text-grey); }
        .success { color: var(--google-green); font-weight: bold; }
        .error { color: var(--google-red); font-weight: bold; }

        /* Donation Section Styles */
        .donate-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; }
        .donate-text { font-size: 13px; color: var(--text-grey); margin-bottom: 15px; font-style: italic; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            .main-wrapper {
                flex-direction: column; 
                padding: 0;
            }
            .instructions-container {
                width: 100%;
                order: -1; 
                margin-bottom: 0;
            }
            .tool-container {
                width: 100%;
                padding: 20px;
            }
            .size-input-wrapper { flex-wrap: wrap; }
            .size-input-group { min-width: 45%; }
            .unit-select { flex-grow: 1; }
            .btn-add { width: 100%; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="instructions-container">
        <div class="instructions-content">
            <h2>How to Use</h2>
            <ul>
                <li><strong>Upload:</strong> Select one or multiple images from your device.</li>
                <li><strong>Trim:</strong> Set a percentage to cut off the bottom (great for removing watermarks). The red area in the preview shows what will be gone.</li>
                <li><strong>Add Sizes:</strong> Enter width and height, choose your unit (px, cm, inch), and click Add. </li>
                <li><strong>Process:</strong> Click the button to crop all images to all sizes instantly.</li>
                <li><strong>Download:</strong> A ZIP file containing all your cropped variations will download automatically.</li>
            </ul>
            <p style="font-size:12px; margin-top:15px; font-style:italic;">*Note: Non-pixel units (cm, in) are converted assuming 96 DPI screen resolution.</p>
            
            <div class="donate-section">
                <p class="donate-text">This batch cropper is entirely free to use. If it has saved you some time, please consider buying me a coffee to support future updates. Cheers!</p>
                <a href="https://www.buymeacoffee.com/PierreCochart" target="_blank">
                    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 45px !important; width: auto !important;" >
                </a>
            </div>

        </div>
    </div>

    <div class="tool-container">
        <h1>Free Batch Image Cropper</h1>
        
        <div class="form-group">
            <label for="baseName">File Base Name</label>
            <input type="text" id="baseName" value="CampaignV1" placeholder="e.g. CampaignV1">
        </div>

        <div class="form-group">
            <label for="trimPercent">Bottom Trim Percentage (%)</label>
            <div class="sub-label">Removes this % from the bottom before cropping</div>
            <input type="number" id="trimPercent" value="10" min="0" max="50" oninput="updatePreview()">
        </div>

        <div class="form-group">
            <label>Target Sizes</label>
            <div class="size-input-wrapper">
                <div class="size-input-group">
                    <input type="number" id="newWidth" placeholder="Width">
                </div>
                <div class="size-input-group">
                    <input type="number" id="newHeight" placeholder="Height">
                </div>
                <select id="newUnit" class="unit-select">
                    <option value="px">px</option>
                    <option value="in">in</option>
                    <option value="cm">cm</option>
                    <option value="mm">mm</option>
                </select>
                <button class="btn-add" onclick="addSize()">+ Add</button>
            </div>
            <div id="sizeList" class="size-list"></div>
        </div>

        <div class="form-group">
            <label for="fileInput">Upload Images</label>
            <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFileSelect()">
            
            <div id="previewContainer">
                <div class="preview-label">Visual Preview</div>
                <div id="previewLegend" class="preview-legend"></div>
                <canvas id="previewCanvas"></canvas>
            </div>
        </div>

        <button id="processBtn" class="btn-process" onclick="processImages()">Process & Download Zip</button>

        <div id="status"></div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    const STORAGE_KEY_SIZES = 'bic_target_sizes_v3';
    const STORAGE_KEY_TRIM = 'bic_trim_percent_v3';

    // Unit Conversion Factors (to pixels, assuming 96 DPI)
    const UNIT_TO_PX = {
        'px': 1,
        'in': 96,
        'cm': 37.795,
        'mm': 3.7795
    };

    const PALETTE = [
        '#4285F4', // Blue
        '#34A853', // Green
        '#FBBC05', // Yellow
        '#A142F4', // Purple
        '#188038', // Dark Green
        '#d93025'  // Dark Red
    ];

    let targetSizes = [
        { w: 1250, h: 600, unit: 'px' },
        { w: 400, h: 250, unit: 'px' },
        { w: 1200, h: 630, unit: 'px' }
    ];
    
    let previewImageBitmap = null; 

    function getColor(index) {
        return PALETTE[index % PALETTE.length];
    }

    // --- PERSISTENCE & INIT ---
    window.onload = function() {
        loadSettings();
        renderSizes();
    };

    function loadSettings() {
        const savedSizes = localStorage.getItem(STORAGE_KEY_SIZES);
        if (savedSizes) {
            try { targetSizes = JSON.parse(savedSizes); } catch (e) { console.error("Error parsing saved sizes"); }
        }
        const savedTrim = localStorage.getItem(STORAGE_KEY_TRIM);
        if (savedTrim) document.getElementById('trimPercent').value = savedTrim;
    }

    function saveSettings() {
        localStorage.setItem(STORAGE_KEY_SIZES, JSON.stringify(targetSizes));
        localStorage.setItem(STORAGE_KEY_TRIM, document.getElementById('trimPercent').value);
    }

    // --- UI FUNCTIONS ---
    function renderSizes() {
        const list = document.getElementById('sizeList');
        list.innerHTML = '';
        
        targetSizes.forEach((size, index) => {
            const color = getColor(index);
            const tag = document.createElement('div');
            tag.className = 'size-tag';
            tag.style.backgroundColor = color;
            
            // Text color for readability
            if (color === '#FBBC05') {
                tag.style.color = '#333';
                tag.style.boxShadow = "inset 0 0 0 1px rgba(0,0,0,0.1)";
            }

            // Display unit if not px, or just px
            const unitDisplay = size.unit || 'px';

            tag.innerHTML = `
                ${size.w} x ${size.h} ${unitDisplay}
                <span class="size-remove" onclick="removeSize(${index})" style="${color === '#FBBC05' ? 'color:#333' : ''}">&times;</span>
            `;
            list.appendChild(tag);
        });
        updatePreview();
    }

    function addSize() {
        const wInput = document.getElementById('newWidth');
        const hInput = document.getElementById('newHeight');
        const uInput = document.getElementById('newUnit');

        const w = parseFloat(wInput.value);
        const h = parseFloat(hInput.value);
        const unit = uInput.value;

        if (!w || !h || w <= 0 || h <= 0) {
            alert("Please enter valid positive numbers.");
            return;
        }

        targetSizes.push({ w, h, unit });
        saveSettings();
        renderSizes();
        
        wInput.value = '';
        hInput.value = '';
        wInput.focus();
    }

    function removeSize(index) {
        targetSizes.splice(index, 1);
        saveSettings();
        renderSizes();
    }

    // --- PREVIEW LOGIC ---
    async function handleFileSelect() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files && fileInput.files[0]) {
            previewImageBitmap = await createImageBitmap(fileInput.files[0]);
            document.getElementById('previewContainer').style.display = 'block';
            updatePreview();
        }
    }

    function updatePreview() {
        saveSettings();
        if (!previewImageBitmap) return;

        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const trimPercentInput = document.getElementById('trimPercent');
        const trimPercent = parseFloat(trimPercentInput.value) || 0;

        const MAX_WIDTH = 700;
        let scale = 1;
        if (previewImageBitmap.width > MAX_WIDTH) {
            scale = MAX_WIDTH / previewImageBitmap.width;
        }
        canvas.width = previewImageBitmap.width * scale;
        canvas.height = previewImageBitmap.height * scale;

        ctx.drawImage(previewImageBitmap, 0, 0, canvas.width, canvas.height);

        const originalW = previewImageBitmap.width;
        const originalH = previewImageBitmap.height;
        const trimHeightPx = Math.floor(originalH * (trimPercent / 100));
        const effectiveH = originalH - trimHeightPx;

        // Draw Trim Overlay
        const scaledTrimHeight = trimHeightPx * scale;
        const scaledTrimYPos = canvas.height - scaledTrimHeight;
        
        if (scaledTrimHeight > 0) {
            ctx.fillStyle = "rgba(234, 67, 53, 0.3)";
            ctx.fillRect(0, scaledTrimYPos, canvas.width, scaledTrimHeight);
            ctx.strokeStyle = "#EA4335";
            ctx.lineWidth = 2;
            ctx.strokeRect(0, scaledTrimYPos, canvas.width, scaledTrimHeight);
        }

        const legendContainer = document.getElementById('previewLegend');
        legendContainer.innerHTML = '<div class="legend-item"><span class="legend-color" style="background:rgba(234, 67, 53, 0.6)"></span> Trimmed</div>';

        // Draw Crop Boxes
        targetSizes.forEach((size, index) => {
            const color = getColor(index);
            
            // Convert Unit to Pixels for calculation
            const factor = UNIT_TO_PX[size.unit || 'px'];
            const targetPxW = size.w * factor;
            const targetPxH = size.h * factor;

            // Logic using pixel values
            const srcRatio = originalW / effectiveH;
            const dstRatio = targetPxW / targetPxH;
            
            let cropBoxWInSrc, cropBoxHInSrc;

            if (srcRatio > dstRatio) {
                cropBoxHInSrc = effectiveH;
                cropBoxWInSrc = cropBoxHInSrc * dstRatio;
            } else {
                cropBoxWInSrc = originalW;
                cropBoxHInSrc = cropBoxWInSrc / dstRatio;
            }

            const cropXInSrc = (originalW - cropBoxWInSrc) / 2;
            const cropYInSrc = (effectiveH - cropBoxHInSrc) / 2;

            const cx = cropXInSrc * scale;
            const cy = cropYInSrc * scale;
            const cw = cropBoxWInSrc * scale;
            const ch = cropBoxHInSrc * scale;

            ctx.beginPath();
            ctx.rect(cx, cy, cw, ch);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.setLineDash([6, 4]);
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 2;
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.shadowColor = "transparent";

            legendContainer.innerHTML += `
                <div class="legend-item">
                    <span class="legend-color" style="background:${color}; border:1px solid #ddd"></span> ${size.w}x${size.h}${size.unit||'px'}
                </div>
            `;
        });
    }

    // --- PROCESSING LOGIC ---
    const log = (msg, isError = false) => {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = 'block';
        const line = document.createElement('div');
        line.textContent = msg;
        if (isError) line.className = 'error';
        statusDiv.appendChild(line);
        statusDiv.scrollTop = statusDiv.scrollHeight;
    };
    const clearLog = () => {
        document.getElementById('status').innerHTML = '';
        document.getElementById('status').style.display = 'none';
    };

    async function processImages() {
        const fileInput = document.getElementById('fileInput');
        const baseNameInput = document.getElementById('baseName');
        const trimPercentInput = document.getElementById('trimPercent');
        const btn = document.getElementById('processBtn');

        if (fileInput.files.length === 0) { alert("Please select images first."); return; }
        if (targetSizes.length === 0) { alert("Please add at least one target size."); return; }

        const baseName = baseNameInput.value.trim() || "Image";
        const trimPercent = parseFloat(trimPercentInput.value) / 100;

        btn.disabled = true;
        btn.textContent = "Processing...";
        clearLog();
        log("Starting process...");

        const zip = new JSZip();
        let totalFiles = fileInput.files.length;

        try {
            for (let i = 0; i < totalFiles; i++) {
                const file = fileInput.files[i];
                log(`Processing: ${file.name}...`);

                const imgBitmap = await createImageBitmap(file);
                const originalW = imgBitmap.width;
                const originalH = imgBitmap.height;
                const trimAmount = Math.floor(originalH * trimPercent);
                const effectiveH = originalH - trimAmount; 

                for (const size of targetSizes) {
                    // Unit Conversion for Processing
                    const factor = UNIT_TO_PX[size.unit || 'px'];
                    const targetPxW = Math.round(size.w * factor);
                    const targetPxH = Math.round(size.h * factor);

                    const blob = await cropCenter(imgBitmap, originalW, effectiveH, targetPxW, targetPxH);
                    
                    let fileName = "";
                    let sizeLabel = `${size.w}x${size.h}${size.unit||'px'}`;
                    
                    if (totalFiles > 1) {
                        fileName = `${baseName}_${i + 1}_${sizeLabel}.jpg`;
                    } else {
                        fileName = `${baseName}_${sizeLabel}.jpg`;
                    }
                    zip.file(fileName, blob);
                }
                log(`Finished ${file.name}`);
            }

            log("\nZipping files...");
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${baseName}_Crops.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            log("Download initiated!", false);
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            successMsg.textContent = "All Done.";
            document.getElementById('status').appendChild(successMsg);

        } catch (error) {
            console.error(error);
            log(`Error: ${error.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = "Process & Download Zip";
        }
    }

    function cropCenter(imgSource, srcW, srcH, targetW, targetH) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            const srcRatio = srcW / srcH;
            const dstRatio = targetW / targetH;
            let renderW, renderH;

            if (srcRatio > dstRatio) {
                renderH = targetH;
                renderW = renderH * srcRatio;
            } else {
                renderW = targetW;
                renderH = renderW / srcRatio;
            }

            const xOffset = (targetW - renderW) / 2;
            const yOffset = (targetH - renderH) / 2;

            ctx.drawImage(imgSource, 0, 0, srcW, srcH, xOffset, yOffset, renderW, renderH);

            canvas.toBlob((blob) => {
                resolve(blob);
            }, 'image/jpeg', 0.95);
        });
    }
</script>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="PierreCochart" data-description="Support me on Buy me a coffee!" data-message="" data-color="#4285F4" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</body>
</html>
